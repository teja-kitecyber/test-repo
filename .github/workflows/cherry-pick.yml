name: Cherry-Pick Squashed Commit to Target Branches

on:
  pull_request:
    types: [closed]
    branches:
      - dev

jobs:
  cherry_pick_squashed_commit:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history to allow cherry-picking

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract PR description
        id: extract_description
        run: echo "${{ github.event.pull_request.body }}" | tee pr_description.txt

      - name: Parse selected branches
        id: parse_branches
        run: |
          # Extract checked branches from the PR description
          branches=$(sed -n '/## 🌍 Target Branches/,/##/ s/- \[x\] \(.*\)/\1/p' pr_description.txt)
          
          # Convert branches to an array (space separated)
          echo "Extracted branches: $branches"

          # Save the branches in an iterable array in GITHUB_ENV
          echo "branches=[$branches]" >> $GITHUB_ENV

      - name: Display the branches
        run: |
          echo "Selected branches: ${{ env.branches }}"

      - name: Use the branches in a loop
        run: |
          for branch in ${{ env.branches }}; do
            echo "Branch: $branch"
          done

      - name: Parse PR Description for Target Branches
        id: parsed_branches
        run: |
          TARGET_BRANCHES=$(echo "${{ github.event.pull_request.body }}" | grep -oP '(?<=- \[x\] `)[^`]+')
          echo "TARGET_BRANCHES=${TARGET_BRANCHES}" >> $GITHUB_ENV

      - name: Get the Squashed Commit SHA
        id: get_commit_sha
        run: |
          # Get the SHA of the merge commit (this will be the squashed commit)
          SQUASHED_COMMIT_SHA=$(jq -r '.pull_request.merge_commit_sha' < $GITHUB_EVENT_PATH)
          echo "SQUASHED_COMMIT_SHA=${SQUASHED_COMMIT_SHA}" >> $GITHUB_ENV

      - name: Cherry-Pick Squashed Commit to Target Branches
        run: |
          for branch in $TARGET_BRANCHES; do
            # Fetch and checkout the target branch
            git fetch origin $branch
            git checkout $branch
            
            # Cherry-pick the squashed commit to the target branch
            git cherry-pick $SQUASHED_COMMIT_SHA

            # Push the cherry-picked commit to the target branch
            git push origin $branch
          done
